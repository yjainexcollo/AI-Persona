import{j as t,B as m,T as c,r as d,k as $}from"./index-CVFjBazT.js";import{H as F}from"./Header-CGK7AgwC.js";import{S as V}from"./SearchBar-N8ZiUfFC.js";import{U as J,A as q,b as G,C as K}from"./ConversationSettingsDialog-BpjzU_w8.js";import{M as Q}from"./MoreVert-B9BrOwKH.js";import{M as P,S as X}from"./AdminSidebar-CF5Hd0jl.js";import{A as Y}from"./Avatar-CRmYJ6bI.js";import{T as Z}from"./Tooltip-BtI0Z-Y-.js";import{I as E}from"./IconButton-DlSDUMzR.js";import{M as ee,a as oe}from"./Menu-OLBZc4RG.js";import{g as te,f as W,c as se,h as z}from"./personaService-DQ8Mj8Y1.js";import{g as ne}from"./avatarService-BCG4JWCu.js";import{C as re}from"./Container-C_QnZiBY.js";import{P as ae}from"./Paper-BgPd5ujD.js";import"./index-JZKuJLno.js";import"./SettingsPage-CyiQULyI.js";import"./createSvgIcon-Cp9E4wFO.js";import"./createSvgIcon-BfE82ItR.js";import"./useControlled-DlQ_-1kq.js";import"./Button-z02TSlFu.js";import"./session-Cma3K_fR.js";import"./workspaceService-CU4ueMZD.js";import"./SwitchBase-DR-Bl87B.js";import"./TextField-DAm2tQd-.js";import"./resolveComponentProps-CTLr-dSE.js";import"./DialogTitle-Bnyi_i4z.js";import"./Alert-vWu0iFBa.js";import"./useSlot-CInQRO00.js";import"./Grid-DMH1W0xs.js";import"./useMediaQuery-DBMDA1h7.js";import"./getThemeProps-DEf1ea3E.js";import"./Stack-D5A5of7w.js";import"./useThemeProps-BUEs0OeN.js";import"./InputAdornment-qZMVxQ_8.js";import"./Divider-C8Z4Hsj1.js";import"./ListItemText-B-JvfqIR.js";import"./Close-C8KCiRLK.js";import"./Person-wxmMnCiP.js";import"./Chip-F7DHNsDx.js";const ie=({tab:p,onTabChange:a})=>t.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:3,mb:2,mt:1,ml:1.5},children:[t.jsx(c,{sx:{fontWeight:600,fontSize:17,color:p==="all"?"#2950DA":"#526794",borderBottom:p==="all"?"2.5px solid #2950DA":"2.5px solid transparent",pb:.5,cursor:"pointer",mr:2},onClick:()=>a("all"),children:"All"}),t.jsx(c,{sx:{fontWeight:600,fontSize:17,color:p==="archived"?"#2950DA":"#526794",borderBottom:p==="archived"?"2.5px solid #2950DA":"2.5px solid transparent",pb:.5,cursor:"pointer"},onClick:()=>a("archived"),children:"Archived"})]}),ce=({avatar:p,name:a,message:f,date:u,archived:h=!1,onClick:I,onRightClick:g,onArchive:x,onUnarchive:S,onShare:y,onConversationSettings:C})=>{const[T,A]=d.useState(null),_=i=>{i.preventDefault(),i.stopPropagation(),A(i.currentTarget)},v=()=>{A(null)},D=i=>{i.preventDefault(),i.stopPropagation(),y&&y(),v()},b=i=>{i.preventDefault(),i.stopPropagation(),C&&C(),v()};return t.jsxs(m,{sx:{display:"flex",alignItems:"center",py:1.2,px:0,borderRadius:2,cursor:"pointer","&:hover":{background:"#f5f8f6"},opacity:h?.7:1},onClick:I,onContextMenu:i=>{i.preventDefault(),g&&g()},children:[t.jsx(Y,{src:p,sx:{width:48,height:48,mr:2,ml:.5}}),t.jsxs(m,{sx:{flex:1,minWidth:0,ml:.5},children:[t.jsx(c,{sx:{fontWeight:700,fontSize:17,color:"#222",lineHeight:1.1},children:a}),t.jsx(c,{sx:{color:"#2950DA",fontWeight:400,fontSize:15,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:400},children:f})]}),t.jsx(c,{sx:{color:"#526794",fontWeight:400,fontSize:15,minWidth:70,textAlign:"right",ml:0,mr:1},children:u}),t.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:.5},children:[(x||S)&&t.jsx(Z,{title:h?"Unarchive":"Archive",children:t.jsx(E,{size:"small",onClick:i=>{i.stopPropagation(),h&&S?S():!h&&x&&x()},sx:{color:h?"#526794":"#666","&:hover":{color:h?"#2950DA":"#333"}},children:h?t.jsx(J,{}):t.jsx(q,{})})}),t.jsx(E,{size:"small",onClick:_,sx:{color:"#666",p:"4px","&:hover":{color:"#1976d2",backgroundColor:"rgba(25, 118, 210, 0.08)"}},children:t.jsx(Q,{sx:{fontSize:16}})})]}),t.jsxs(ee,{anchorEl:T,open:!!T,onClose:v,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[t.jsxs(P,{onClick:i=>D(i),children:[t.jsx(G,{sx:{mr:1}})," Share"]}),t.jsxs(P,{onClick:i=>b(i),children:[t.jsx(X,{sx:{mr:1}})," Conversation Settings"]})]})]})},le=({chats:p})=>t.jsx(m,{ml:2,children:p.map((a,f)=>t.jsx(m,{sx:{mb:.5},children:t.jsx(ce,{avatar:a.avatar,name:a.name,message:a.message,date:a.date,archived:a.archived,onClick:a.onClick,onRightClick:a.onRightClick,onArchive:a.onArchive,onUnarchive:a.onUnarchive,onShare:a.onShare,onConversationSettings:a.onConversationSettings})},f))}),Ke=()=>{const p=$(),[a,f]=d.useState("all"),[u,h]=d.useState(""),[I,g]=d.useState([]),[x,S]=d.useState(null),[y,C]=d.useState(!1),[T,A]=d.useState([]),[_,v]=d.useState(!1),[D,b]=d.useState(null);d.useEffect(()=>{async function o(){try{const s=await te();A(s.data||[])}catch(s){console.error("Error fetching personas from backend:",s),A([])}}o()},[]);const i=async o=>{const s=o.personaId,e=o.conversation_id,n=o.sessionId;if(s&&e){const r=n?`/chat/${s}?conversationId=${e}&sessionId=${n}`:`/chat/${s}?conversationId=${e}`;p(r)}else console.error(`Persona ID or conversation ID not found for session: ${o.conversation_id}`)},U=async()=>{const o=await W();if(o&&o.length>0){const s=o.map(e=>{const n=e.messages||[],r=n[n.length-1];return{conversation_id:e.conversation.id,persona:e.persona.name,personaId:e.persona.id,sessionId:e.sessionId,last_message:(r==null?void 0:r.content)||"No messages",date:new Date(e.conversation.updatedAt).toLocaleDateString(),chats:n.map(l=>({persona:e.persona.name,user_message:l.role==="USER"?l.content:"",ai_response:l.role==="ASSISTANT"?l.content:"",timestamp:l.createdAt,conversation_id:e.conversation.id,archived:!!e.conversation.archivedAt})),archived:!!e.conversation.archivedAt,lastTimestamp:e.conversation.updatedAt}});s.sort((e,n)=>new Date(n.lastTimestamp).getTime()-new Date(e.lastTimestamp).getTime()),g(s)}else g([])};d.useEffect(()=>{let o="";try{const e=JSON.parse(localStorage.getItem("user")||"{}");o=e.id||"",console.log("User from localStorage:",e),console.log("User ID:",o)}catch(e){console.error("Error parsing user from localStorage:",e)}if(!o){console.log("No user ID found, skipping fetch");return}console.log("Starting chat history fetch for tab:",a),(async()=>{try{console.log("Fetching chat sessions from backend API");const e=await W();if(console.log("Chat sessions fetched from backend:",e),e&&e.length>0){const n=e.map(r=>{const l=r.messages||[],k=l[l.length-1];return{conversation_id:r.conversation.id,persona:r.persona.name,personaId:r.persona.id,sessionId:r.sessionId,last_message:(k==null?void 0:k.content)||"No messages",date:new Date(r.conversation.updatedAt).toLocaleDateString(),chats:l.map(j=>({persona:r.persona.name,user_message:j.role==="USER"?j.content:"",ai_response:j.role==="ASSISTANT"?j.content:"",timestamp:j.createdAt,conversation_id:r.conversation.id,archived:!!r.conversation.archivedAt})),archived:!!r.conversation.archivedAt,lastTimestamp:r.conversation.updatedAt}});n.sort((r,l)=>new Date(l.lastTimestamp).getTime()-new Date(r.lastTimestamp).getTime()),console.log("Sessions created:",n.length),console.log("All sessions:",n.map(r=>({conversation_id:r.conversation_id,persona:r.persona,count:r.chats.length,archived:r.archived}))),g(n)}else console.log("No chat sessions found"),g([])}catch(e){console.error("Error fetching chat sessions:",e),g([])}})()},[a]);const M=I.filter(o=>{const s=o.persona.toLowerCase().includes(u.toLowerCase())||o.last_message.toLowerCase().includes(u.toLowerCase()),e=a==="all"?!o.archived:o.archived;return s&&e}),N=async o=>{console.log("Share button clicked for conversation:",o);try{const e=(await se(o)).data.url;await navigator.clipboard.writeText(e),console.log("Share link copied to clipboard:",e)}catch(s){console.error("Error creating share link:",s)}},H=o=>{const s=I.find(e=>e.conversation_id===o);if(s){const e={id:s.conversation_id,title:s.persona,persona:{id:s.personaId,name:s.persona},personaId:s.personaId,userId:"",user:{id:"",name:"",email:""},messages:s.chats.map(n=>({id:n.timestamp,content:n.user_message||n.ai_response,role:n.user_message?"USER":"ASSISTANT",createdAt:n.timestamp,updatedAt:n.timestamp})),createdAt:s.lastTimestamp,updatedAt:s.lastTimestamp,archivedAt:s.archived?s.lastTimestamp:null,visibility:"PRIVATE",_count:{messages:s.chats.length}};b(e),v(!0)}},O=async o=>{try{await z(o.conversation_id,!0),await U()}catch(s){console.error("Failed to archive conversation",s)}},L=async o=>{try{await z(o.conversation_id,!1),await U()}catch(s){console.error("Failed to unarchive conversation",s)}},R=(o,s)=>{g(e=>e.map(n=>n.conversation_id===o?{...n,archived:!!s.archivedAt,lastTimestamp:s.updatedAt||n.lastTimestamp}:n))},B=()=>{v(!1),b(null)},w=M.map((o,s)=>{console.log("Mapping session:",o);const e=T.find(r=>r.id===o.personaId);console.log("Found persona for session:",e);const n={avatar:ne((e==null?void 0:e.avatarUrl)||(e==null?void 0:e.avatar)||""),name:(e==null?void 0:e.name)||`Persona: ${o.persona}`,message:o.last_message,date:o.date,archived:o.archived,onClick:()=>{console.log("Session clicked:",o),i(o)},onRightClick:()=>{S(o),C(!0)},onArchive:()=>O(o),onUnarchive:()=>L(o),onShare:()=>N(o.conversation_id),onConversationSettings:()=>H(o.conversation_id),key:o.conversation_id+"-"+s};return console.log("Created chat object:",n),n});return console.log("Chats array for UI:",w),t.jsxs(m,{sx:{minHeight:"100vh",backgroundColor:"#ffffff"},children:[t.jsx(F,{}),t.jsxs(re,{sx:{py:{xs:2,md:4},maxWidth:900},children:[t.jsx(m,{sx:{width:"100%",mx:"auto",mb:2,px:{xs:0,md:1}},children:t.jsx(V,{value:u,onChange:h,placeholder:"Search",fullWidth:!0,maxWidth:1200})}),t.jsx(m,{sx:{px:{xs:0,md:1}},children:t.jsx(ie,{tab:a,onTabChange:f})}),w.length>0?t.jsx(le,{chats:w}):t.jsxs(m,{sx:{textAlign:"center",py:4,color:"#666"},children:[t.jsx(c,{variant:"h6",children:"No chat history found"}),t.jsx(c,{variant:"body2",sx:{mt:1},children:"Start chatting with personas to see your conversation history here."})]}),t.jsx(oe,{open:y,onClose:()=>C(!1),children:t.jsxs(ae,{sx:{maxWidth:600,mx:"auto",my:8,p:4,outline:"none"},children:[t.jsx(c,{variant:"h6",sx:{mb:2},children:"Session Details"}),x&&x.chats.length>0?x.chats.map((o,s)=>t.jsxs(m,{sx:{mb:2,p:2,bgcolor:"#f5f5f5",borderRadius:2},children:[t.jsxs(c,{sx:{fontWeight:700},children:["Persona: ",o.persona]}),t.jsxs(c,{sx:{color:"#333",mt:1},children:["User: ",o.user_message]}),t.jsxs(c,{sx:{color:"#2950DA",mt:1},children:["AI: ",o.ai_response]}),t.jsx(c,{sx:{color:"#888",fontSize:13,mt:1},children:new Date(o.timestamp).toLocaleString()})]},s)):t.jsx(c,{children:"No messages in this session."})]})}),t.jsx(K,{open:_,onClose:B,conversation:D,onConversationUpdate:R})]})]})};export{Ke as default};
